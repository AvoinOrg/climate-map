<!DOCTYPE html>
<html lang='en'>

<head>
    <meta charset='utf-8' />
    <title>Button Climate Map</title>
    <meta name='viewport' content='initial-scale=1,width=device-width,maximum-scale=1,user-scalable=no' />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/mapbox-gl/0.50.0/mapbox-gl.js" integrity="sha256-lt9+iIQZba05r6TN/Z7hzHD+QOWXdlzgARKHfA0U3ks=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mapbox-gl/0.50.0/mapbox-gl.css" integrity="sha256-coh6R3HyiYSLAbMk4lZIr5txQq3BdbN0nKl1U4iioNU=" crossorigin="anonymous" />

    <!-- plus.codes: -->
    <!-- <script async defer src="https://cdnjs.cloudflare.com/ajax/libs/openlocationcode/1.0.3/openlocationcode.min.js" integrity="sha256-cN2Y69HQRLjefvPHJKXQ9Dgkfug2odevw9BBdiyVExQ=" crossorigin="anonymous"></script> -->

    <script src="https://cdn.auth0.com/js/auth0/9.10/auth0.min.js"></script>
    <script src="auth.js"></script>
    <script type="text/javascript">
        const AUTH0_CLIENT_ID = "It20v2Ec7GO3lJ57uWRSItK5WsWVODhc";
        const AUTH0_DOMAIN = "button.eu.auth0.com";
        window.addEventListener('load', window.initAuthWithClaims);
    </script>

    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        #no2 {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background-color: white;
            color: black;
            font-family: Arial, sans-serif;
        }

        .logo {
            max-width: 10vw;
        }

        .circle-icon:hover {
            cursor: pointer;
        }
        .circle-icon {
            background: #ffffff;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            text-align: center;
            line-height: 50px;
            vertical-align: middle;
            padding: 15px;
        }
        #menu-container{
            font-size: 30px;
            position: absolute;
            top: 0;
            left: 0;
            width: 500px;
            height: 100%;
            padding: 0 30px;
            background: #ffffff;
        }
        #menu-container .ui-button {
            left: 550px;
        }
        .menu-button-container{
            position: fixed;
            top: 0;
            left: 0;
            padding-top: 50px;
            padding-left: 50px;
        }
        .satellite-button-container{
            position: fixed;
            bottom: 0;
            left: 0;
            padding-bottom: 50px;
            padding-left: 50px;
            /* background: rgba(255, 255, 255, 0.8); */
            /* margin-right: 20px; */
            /* overflow: auto; */
            border-radius: 3px;
        }

        .layer-card {
            margin-bottom: 30px;
            font-size: 20px;
        }
        .layer-card .title {
            font-size: 30px;
            display: inline-block;
        }
        .layer-card p {
            color: #404040;
        }
        .layer-disabled {
            color: #969696;
        }

        .onoffswitch {
            position: relative; width: 48px;
            -webkit-user-select:none; -moz-user-select:none; -ms-user-select: none;
            float: right;
        }
        .onoffswitch-checkbox {
            display: none;
        }
        .onoffswitch-label {
            display: block; overflow: hidden; cursor: pointer;
            height: 20px; padding: 0; line-height: 20px;
            border: 2px solid #FFFFFF; border-radius: 20px;
            background-color: #A8A8A8;
            transition: background-color 0.15s ease-in;
        }
        .onoffswitch-label:before {
            content: "";
            display: block; width: 20px; margin: 0px;
            background: #FFFFFF;
            position: absolute; top: 0; bottom: 0;
            right: 26px;
            border: 2px solid #FFFFFF; border-radius: 20px;
            transition: all 0.15s ease-in 0s;
        }
        .onoffswitch-checkbox:checked + .onoffswitch-label {
            background-color: #191C1F;
        }
        .onoffswitch-checkbox:checked + .onoffswitch-label, .onoffswitch-checkbox:checked + .onoffswitch-label:before {
            border-color: #191C1F;
        }
        .onoffswitch-checkbox:checked + .onoffswitch-label:before {
            right: 0px;
        }

        *[hidden] { display: none; }

        #btn-logout:hover, #btn-login:hover {
            cursor: pointer;
        }
        #btn-logout, #btn-login {
            background: #333;
            color: #eee;
            font-size: 24px;
            position: absolute;
            top:15px;
            right: 60px;
        }
    </style>
</head>

<body onload='onload()'>
    <script>
        const backgroundLayerGroups = { 'terramonitor': true }
        const layerGroupState = {
            'terramonitor': true,
        }
        // Set up event handlers for layer toggles, etc.
        window.onload = function() {
            document.querySelectorAll('.layer-card input').forEach(el => {
                if (el.disabled) return;

                el.addEventListener('change', () => window.toggleGroup(el.id));

                // Populate layer state from DOM.
                layerGroupState[el.id] = el.checked;
                const known = el.id in layerGroups;
                if (!known) {
                    console.log('ERROR: Unknown layer in menu .layer-cards:', el.id, el);
                }
            })
        };

        window.layerOriginalPaint = {}
        window.toggleBaseMapSymbols = function() {
            map.getStyle().layers.filter(x => x.type === 'symbol').forEach(layer => {
                if (layerGroupState.terramonitor) {
                    layer.paint = window.layerOriginalPaint[layer.id];
                } else {
                    window.invertLayerTextHalo(layer);
                }
                map.removeLayer(layer.id);
                map.addLayer(layer);
            })
        }

        const layerGroups = {
            'peatland-co2': ['peatland-co2', 'peatland-co2-sym', 'peatland-outline'],
            'valio': [
            () => window.hideAll(x=>!/valio/.test(x)),
            'valio-fields-boundary', 'valio-fields-fill', 'valio-plohko-co2-sym',
            ],
            'histosol-field-co2': ['plohko-fill', 'plohko-co2-sym', 'plohko-outline'],
            'forest-grid': ['metsaan-hila-c', 'metsaan-hila-sym', 'metsaan-hila-outline'],
            'privately-owned-forests': ['metsaan-stand-others-c'],
            'zonation6': ['zonation-v6-raster'],
            'ete': ['metsaan-ete-all-c', 'metsaan-ete-all-outline', 'metsaan-ete-all-sym'],
            'ete-all-labels': [() => window.useAllEteCodes()],
            'terramonitor': ['terramonitor', () => window.toggleBaseMapSymbols()],
            'no2-raster': ['no2-raster', () => window.setNO2()],
            'mangrove-forests': ['mangrove-wms'],
        };
        window.toggleSatellite = function() {
            document.querySelectorAll('.satellite-button-container img').forEach(x => x.toggleAttribute('hidden'));
            window.toggleGroup('terramonitor')
        }
        window.toggleMenu = function() {
            document.querySelectorAll('.menu-toggle').forEach(x => x.toggleAttribute('hidden'))
        }

        window.toggleGroup = function(group, forcedState=undefined) {
            const oldState = layerGroupState[group];
            const newState = forcedState === undefined ? !oldState : forcedState;
            if (oldState === newState) return;

            const el = document.querySelector(`.layer-card input#${group}`)
            if (el) el.checked = newState

            layerGroups[group].forEach(layer => {
                if (typeof layer === 'function') {
                    layer();
                } else {
                    map.setLayoutProperty(layer, 'visibility', newState ? 'visible' : 'none')
                }
            })
            layerGroupState[group] = newState;
        }
        // NB: Use with caution. Very heavy.
        window.enableAllEteCodes = function() {
            fetch('ete_codes.json').then(function(response) {
                response.json().then(e => {
                    window.useAllEteCodes(e);
                    window.toggleGroup('ete');
                })
            })
        }

        window.hideAll = function (filterFn) {
            Object.keys(layerGroupState).forEach(group => {
                const layerIsInBackground = group in backgroundLayerGroups;
                if (layerIsInBackground) return;
                if (filterFn && !filterFn(group)) return;
                window.toggleGroup(group, forcedState=false);
            })
        }

        window.invertLayerTextHalo = function(layer) {
            layer.paint = {...layer.paint}
            if (layer.paint && layer.paint["text-halo-width"]) {
                // Original style is something like:
                // text-color: "#999"
                // text-halo-blur: 1
                // text-halo-color: "rgb(242,243,240)"
                // text-halo-width: 2
                layer.paint['text-halo-blur'] = 1
                layer.paint['text-halo-width'] = 2.5
                layer.paint['text-color'] = '#fff'
                layer.paint['text-halo-color'] = '#000'
            }
        }

        window.enableDefaultLayers = function() {
            Object.entries(layerGroupState).forEach(([group, enabled]) => {
                enabled && layerGroups[group].forEach(layer => {
                    typeof layer === 'string' &&
                    map.setLayoutProperty(layer, 'visibility', 'visible');
                });
            })
        }

    </script>
    <div id='map'></div>

    <div id='btn-logout' hidden>Logout</div>
    <div id='btn-login'>Login</div>

    <div class='menu-button-container menu-toggle' onclick="toggleMenu();">
        <img class='circle-icon menu' src='outline-menu-24px.svg'/>
    </div>

    <div class='satellite-button-container' onclick="toggleSatellite();">
        <img class='circle-icon' src='outline-terrain-24px.svg'/>
        <img class='circle-icon' src='outline-satellite-24px.svg' hidden />
    </div>

    <div id='menu-container' class='menu-toggle' hidden>
        <div class='menu-button-container ui-button' onclick="toggleMenu();">
            <img class='circle-icon close' src='outline-close-24px.svg'/>
        </div>

        <div class='satellite-button-container ui-button' onclick="toggleSatellite();">
            <img class='circle-icon' src='outline-terrain-24px.svg'/>
            <img class='circle-icon' src='outline-satellite-24px.svg' hidden />
        </div>

        <h1>Sustainability Map</h1>

        <p>
            Map displaying areas where actions are required in order to save environmental resources
        </p>

        <div class='layer-card'>
            <div class='title'>Peatland CO2</div>
            <div class="onoffswitch">
                <input type="checkbox" name="onoffswitch" class="onoffswitch-checkbox" id="peatland-co2" checked>
                <label class="onoffswitch-label" for="peatland-co2"></label>
            </div>
        </div>

        <div class='layer-card'>
            <div class='title'>Mangrove forests</div>
            <div class="onoffswitch">
                <input type="checkbox" name="onoffswitch" class="onoffswitch-checkbox" id="mangrove-forests" checked>
                <label class="onoffswitch-label" for="mangrove-forests"></label>
            </div>
        </div>

        <div class='layer-card'>
            <div class='title'>Air pollution indicator NO2</div>
            <div class="onoffswitch">
                <input type="checkbox" name="onoffswitch" class="onoffswitch-checkbox" id="no2-raster">
                <label class="onoffswitch-label" for="no2-raster"></label>
            </div>
            <p>
                Burning of fossil fuel creates oir pollutants such as NO2 and small particles.
            </p>
            <strong>Air cleanliness</strong>
            <p>
                The satellite NO2 data is based on Sentinel 5P measurements and is updated approximately once per 24 hours for any given location.

                A healthy threshold of NO2 is around 50 umol/m<sup>2</sup>.
            </p>
        </div>

        <div class='layer-card'>
            <div class='title'>Histosol Field CO2</div>
            <div class="onoffswitch">
                <input type="checkbox" name="onoffswitch" class="onoffswitch-checkbox" id="histosol-field-co2" checked>
                <label class="onoffswitch-label" for="histosol-field-co2"></label>
            </div>
        </div>


        <div class='layer-card'>
            <div class='title'>Forest Grid Measurements</div>
            <div class="onoffswitch">
                <input type="checkbox" name="onoffswitch" class="onoffswitch-checkbox" id="forest-grid">
                <label class="onoffswitch-label" for="forest-grid"></label>
            </div>
        </div>



        <div class='layer-card'>
            <div class='title'>Privately owned forests</div>
            <div class="onoffswitch">
                <input type="checkbox" name="onoffswitch" class="onoffswitch-checkbox" id="privately-owned-forests">
                <label class="onoffswitch-label" for="privately-owned-forests"></label>
            </div>
        </div>


        <div class='layer-card' hidden id='layer-card-valio'>
            <div class='title'>Valio Supply Chain Fields</div>
            <div class="onoffswitch">
                <input type="checkbox" name="onoffswitch" class="onoffswitch-checkbox" id="valio">
                <label class="onoffswitch-label" for="valio"></label>
            </div>
        </div>

        <hr/>

        <div class='layer-card'>
            <div class='title'>Areas important to diversity</div>
            <div class="onoffswitch">
                <input type="checkbox" name="onoffswitch" class="onoffswitch-checkbox" id="zonation6">
                <label class="onoffswitch-label" for="zonation6"></label>
            </div>
            <p>
                This layer comprises of the Zonation MetZa2018 data.
                The top 5 and top 10% most important habitats in Finland, coded dark green and light green, respectively.
            </p>
        </div>

        <div class='layer-card'>
            <div class='title'>Especially Important Habitats</div>
            <div class="onoffswitch">
                <input type="checkbox" name="onoffswitch" class="onoffswitch-checkbox" id="ete">
                <label class="onoffswitch-label" for="ete"></label>
            </div>
        </div>


        <div class='layer-card'>
            <div class='title'>Display ALL Habitat Descriptions</div>
            <div class="onoffswitch">
                <input type="checkbox" name="onoffswitch" class="onoffswitch-checkbox" id="ete-all-labels" onchange="window.enableAllEteCodes();">
                <label class="onoffswitch-label" for="ete-all-labels"></label>
            </div>
        </div>

        <hr/>


        <div class='layer-card layer-disabled'>
            <div class='title'>Mature forests</div>
            <div class="onoffswitch">
                <input type="checkbox" name="onoffswitch" class="onoffswitch-checkbox" id="mature-forests" disabled>
                <label class="onoffswitch-label" for="mature-forests"></label>
            </div>
        </div>


        <div class='layer-card layer-disabled'>
            <div class='title'>Municipal forests</div>
            <div class="onoffswitch">
                <input type="checkbox" name="onoffswitch" class="onoffswitch-checkbox" id="municipal-forests" disabled>
                <label class="onoffswitch-label" for="municipal-forests"></label>
            </div>
        </div>


        <div class='layer-card layer-disabled'>
            <div class='title'>Wetlands</div>
            <div class="onoffswitch">
                <input type="checkbox" name="onoffswitch" class="onoffswitch-checkbox" id="wetlands" disabled>
                <label class="onoffswitch-label" for="wetlands"></label>
            </div>
        </div>


        <div class='layer-card layer-disabled'>
            <div class='title'>Pasture fields</div>
            <div class="onoffswitch">
                <input type="checkbox" name="onoffswitch" class="onoffswitch-checkbox" id="pasture-fields" disabled>
                <label class="onoffswitch-label" for="pasture-fields"></label>
            </div>
        </div>


        <hr /><br/>
        <img alt="Metsäkeskus" src="metsakeskus_logo.jpg" class="logo">
        <img alt="Terramonitor" src="terramonitor_logo.jpg" class="logo">
        <br/>
        <img alt="Copernicus" src="copernicus_logo.jpg" class="logo">
        <img alt="ESA, European Space Agency" src="esa_logo.jpg" class="logo">
        <br/>
        <img alt="Mavi" src="mavi_logo.jpg" class="logo">
        <img alt="Luke" src="luke_logo.jpg" class="logo">

    </div>


    <output id='no2'></output>

    <script>
        // This must be set, but the value is not needed here.
        mapboxgl.accessToken = 'not-needed';

        const style = {
            "version": 8,
            "glyphs": "https://map.buttonprogram.org/suot/font/{fontstack}/{range}.pbf",
            "layers": [
            {
                "id": "background",
                "type": "background",
                "paint": {
                    "background-color": "#ddeeff"
                }
            },
            ]
        }

        const map = new mapboxgl.Map({
            container: 'map', // container id
            // style,
            style: 'https://tiles.stadiamaps.com/styles/alidade_smooth.json',
            center: [28, 65], // starting position [lng, lat]
            zoom: 5, // starting zoom
            attributionControl: false,
        });
        window.map = map;

        map.addControl(new mapboxgl.NavigationControl());

        const originalMapLayerIds = {}

        map.on('load', function () {

            map.addLayer({
                'id': 'terramonitor',
                'type': 'raster',
                'source': {
                    'type': 'raster',
                    'tiles': [
                    'https://maps.terramonitor.com/9c2040ec0fb91cfdfd723496515d759a77b363ee/pro/wms?bbox={bbox-epsg-3857}&format=image/jpeg&service=WMS&version=1.1.1&request=GetMap&srs=EPSG:3857&transparent=true&width=256&height=256&layers=rgb&styles=',
                    ],
                    'tileSize': 256,
                    // "maxzoom": 16, // After zoom level 16 the images (used to) get blurrier
                },
                'paint': {},
            });

            // Custom attribution for Terramonitor since the WMS source doesn't present show one automatically.
            map.addControl(new mapboxgl.AttributionControl({
                customAttribution: '<a href="https://www.terramonitor.com">© Terramonitor</a> | <a href="http://mavi.fi">© Maaseutuvirasto 2018</a>'
            }));

            map.getStyle().layers.forEach(x => originalMapLayerIds[x.id] = true)

            map.addSource('stand-suot', {
                "type": "vector",
                "tiles": ["https://map.buttonprogram.org/stand-suot/{z}/{x}/{y}.pbf"],
                "maxzoom": 12,
            });

            map.addSource('metsaan-stand-others', {
                "type": "vector",
                "tiles": ["https://map.buttonprogram.org/stand-others/{z}/{x}/{y}.pbf"],
                "maxzoom": 13,
            });

            map.addSource('metsaan-hila', {
                "type": "vector",
                "tiles": ["https://map.buttonprogram.org/metsaan-hila/{z}/{x}/{y}.pbf"],
                "maxzoom": 15,
            });

            map.addSource('metsaan-ete', {
                "type": "vector",
                "tiles": ["https://map.buttonprogram.org/metsaan-ete/{z}/{x}/{y}.pbf"],
                "maxzoom": 12,
            });

            map.addSource('histosol_plohko', {
                "type": "vector",
                "tiles": ["https://map.buttonprogram.org/peltolohko/histosol_plohko/{z}/{x}/{y}.pbf"],
                "maxzoom": 11,
            });

            map.addLayer({
                'id': 'metsaan-stand-others-c',
                'source': 'metsaan-stand-others',
                'source-layer': 'stand-others',
                'type': 'fill',
                'paint': {
                    'fill-color': 'brown',
                    'fill-opacity': 0.5
                },
            })



            map.addLayer({
                'id': 'metsaan-hila-c',
                'source': 'metsaan-hila',
                'source-layer': 'metsaan-hila',
                'type': 'fill',
                'paint': {
                    'fill-color': [
                    'interpolate',
                    ['linear'],
                    ['get', 'age'],
                    0, 'rgb(218,248,85)', // green
                    70, 'rgb(252,113,34)', // orange
                    100, 'rgb(245,17,72)', // red
                    ],
                    'fill-opacity': 0.9
                },
            })
            map.addLayer({
                'id': 'metsaan-hila-outline',
                'source': 'metsaan-hila',
                'source-layer': 'metsaan-hila',
                'type': 'line',
                "minzoom": 14,
                'paint': {
                    'line-opacity': 0.75,
                }
            })
            map.addLayer({
                'id': 'metsaan-hila-sym',
                'source': 'metsaan-hila',
                'source-layer': 'metsaan-hila',
                'type': 'symbol',
                "minzoom": 15,
                // 'maxzoom': zoomThreshold,
                "paint": {},
                "layout": {
                    "symbol-placement": "point",
                    "text-font": ["Open Sans Regular"],
                    "text-field": 'Age:{age} Avg.Diameter:{meandiameter}',
                    "text-size": 10,
                }
            })


            map.addSource('metsaan-ete-gamekeeping-area', {
                "type": "geojson",
                "data": "https://map.buttonprogram.org/suot/ete_gamekeeping_area.geojson?v=1",
            });
            map.addSource('metsaan-ete-possibly-metso', {
                "type": "geojson",
                "data": "https://map.buttonprogram.org/suot/ete_possibly_metso.geojson?v=1",
            });
            map.addSource('metsaan-ete-metso', {
                "type": "geojson",
                "data": "https://map.buttonprogram.org/suot/ete_metso.geojson?v=1",
            });


            map.addLayer({
                'id': 'metsaan-ete-gamekeeping-area-c',
                'source': 'metsaan-ete-gamekeeping-area',
                'type': 'fill',
                'paint': {
                    'fill-color': '#40d040',
                    'fill-opacity': 0.7,
                },
            })
            map.addLayer({
                'id': 'metsaan-ete-possibly-metso-c',
                'source': 'metsaan-ete-possibly-metso',
                'type': 'fill',
                'paint': {
                    'fill-color': '#40d040',
                    'fill-opacity': 0.7,
                },
            })
            map.addLayer({
                'id': 'metsaan-ete-metso-c',
                'source': 'metsaan-ete-metso',
                'type': 'fill',
                'paint': {
                    'fill-color': '#40d040',
                    'fill-opacity': 0.7,
                },
            })


            map.addLayer({
                'id': 'metsaan-ete-all-c',
                'source': 'metsaan-ete',
                'source-layer': 'metsaan-ete',
                'type': 'fill',
                'paint': {
                    'fill-color': 'cyan',
                    'fill-opacity': 0.7,
                },
            })
            map.addLayer({
                'id': 'metsaan-ete-all-outline',
                'source': 'metsaan-ete',
                'source-layer': 'metsaan-ete',
                'type': 'line',
                "minzoom": 12,
                'paint': {
                    'line-opacity': 1,
                }
            })
            map.addLayer({
                'id': 'metsaan-ete-all-sym',
                'source': 'metsaan-ete',
                'source-layer': 'metsaan-ete',
                'type': 'symbol',
                "layout": {
                    "text-font": ["Open Sans Regular"],
                    "text-field": [
                    "match",
                    ["get","featurecode"],
                    70, "Gamekeeping area",
                    95, "Potential METSO Habitat",
                    98, "METSO Habitat",
                    10120, "Gamekeeping area",
                    15150, "METSO II",
                    "",
                    ],
                    // "icon-image": "https://example.com/METSO_logo08_FI.gif",
                    //  [
                    //     // "step",
                    //     // [
                    //     //     "zoom"
                    //     // ],
                    //     // [
                    //         "match", ["get","featurecode"],
                    //         "95", "METSO_logo08_FI.gif",
                    //         null
                    // ],
                    // "text-field": ["get", "featurecode"],
                },
                paint: {
                    'text-color': "#999",
                    'text-halo-blur': 1,
                    'text-halo-color': "rgb(242,243,240)",
                    'text-halo-width': 2,
                },
            })


            map.addLayer({
                'id': 'plohko-fill',
                'source': 'histosol_plohko',
                'source-layer': 'suopellot',
                'type': 'fill',
                'paint': {
                    'fill-color': 'red',
                    'fill-opacity': 1
                }
            })
            map.addLayer({
                'id': 'plohko-outline',
                'source': 'histosol_plohko',
                'source-layer': 'suopellot',
                'type': 'line',
                "minzoom": 11,
                'paint': {
                    'line-opacity': 0.75,
                }
            })

            map.addLayer({
                'id': 'peatland-co2',
                'source': 'stand-suot',
                'source-layer': 'stand-suot',
                // 'maxzoom': zoomThreshold,
                'type': 'fill',
                // 'filter': ['==', 'isState', true],
                'paint': {
                    'fill-color': [
                    'interpolate',
                    ['linear'],
                    ['get', 'fertilityclass'],
                    1, 'rgb(245,17,72)', // red
                    4, 'rgb(252,113,34)', // orange
                    // 8, 'rgb(218,248,85)',
                    6, 'rgb(218,248,85)', // green
                    ],
                    // 'fill-outline-color': [
                    //     'interpolate',
                    //     ['linear'],
                    //     ['get', 'drainagestate'],
                    //     6, 'rgb(89, 122, 155)',
                    //     // 7, 'rgb(252,113,34)',
                    //     // 8, 'rgb(218,248,85)',
                    //     9, 'rgb(0, 77, 153)',
                    // ],
                    'fill-opacity': 0.9
                },
            })
            map.addLayer({
                'id': 'peatland-outline',
                'source': 'stand-suot',
                'source-layer': 'stand-suot',
                'type': 'line',
                "minzoom": 11,
                'paint': {
                    'line-opacity': 0.75,
                }
            })

            map.addLayer({
                'id': 'peatland-co2-sym',
                'source': 'stand-suot',
                'source-layer': 'stand-suot',
                'type': 'symbol',
                "minzoom": 12,
                // 'maxzoom': zoomThreshold,
                "paint": {},
                "layout": {
                    "symbol-placement": "point",
                    "text-font": ["Open Sans Regular"],
                    "text-field":
                    ["let", "suffix", "t CO2e/y",
                    ["concat",
                    ["to-string",
                    ["/",
                    ["round",
                    ["*", 1.5,
                    ["get", "co2"]]], 10]],
                    ["var", "suffix"]]],

                    "text-size": 20,
                }
            })

            map.addLayer({
                'id': 'plohko-co2-sym',
                'source': 'histosol_plohko',
                'source-layer': 'suopellot',
                'type': 'symbol',
                "minzoom": 12,
                // 'maxzoom': zoomThreshold,
                "paint": {},
                "layout": {
                    "symbol-placement": "point",
                    "text-font": ["Open Sans Regular"],
                    // NB: 400t CO2eq/ha/20yrs -> 2kg/m2/y
                    // round(0.0002*total_area) -> reduce precision -> *10 -> 2kg/m2
                    "text-field":
                    ["let", "suffix", "t CO2e/y",
                    ["concat",
                    ["to-string",
                    ["*", 10,
                    ["round", ["*", 0.0002, ["get", "total_area"]]],
                    ]],
                    ["var", "suffix"]]],

                    "text-size": 20,
                }
            })


            let no2Tileset = Number.parseInt( window.location.search.substring(1) ) || 0
            const timestampHour = Math.round(+new Date() / 1e6)
            map.addSource('no2-tiles', {
                "type": "raster",
                "tiles": ["https://map.buttonprogram.org/atmoshack/mbtiles-dump/" + no2Tileset + "/{z}/{x}/{y}.png?v=5&_=" + timestampHour],
                "maxzoom": 5,
            });

            map.addLayer({
                'id': 'no2-raster',
                'source': 'no2-tiles',
                'type': 'raster',
                'minzoom': 0,
                'maxzoom': 10,
            })


            map.addLayer({
                'id': 'mangrove-wms',
                'type': 'raster',
                'source': {
                    'type': 'raster',
                    'tiles': [
                    'https://gis.unep-wcmc.org/arcgis/services/marine/GMW_001_MangroveDistribition_2010/MapServer/WMSServer?bbox={bbox-epsg-3857}&format=image/png&service=WMS&version=1.1.1&request=GetMap&srs=EPSG:3857&transparent=true&width=256&height=256&layers=0&styles=default',
                    ],
                    'tileSize': 256
                },
                'paint': {}
            })

            const zonationVersions = [1,2,3,4,5,6]
            zonationVersions.map(v => {
                const sourceName = `zonation-v${v}`
                const id = `${sourceName}-raster`
                map.addSource(sourceName, {
                    "type": "raster",
                    "tiles": [`https://map.buttonprogram.org/suot/zonation/MetZa2018_VMA0${v}/{z}/{x}/{y}.png?v=5`],
                    "minzoom": 5,
                    "maxzoom": 9,
                });
                map.addLayer({
                    id,
                    'source': sourceName,
                    'type': 'raster',
                    'minzoom': 0,
                    // 'maxzoom': 10,
                })
                map.setPaintProperty(id, 'raster-opacity', 0.6)
            })

            // Hide new layers by default.
            map.getStyle().layers.map(layer => {
                const isOldLayer = layer.id in originalMapLayerIds
                isOldLayer || map.setLayoutProperty(layer.id, 'visibility', 'none')
            })

            window.enableDefaultLayers();

            map.setPaintProperty('no2-raster', 'raster-opacity', 0.7)
            // map.setPaintProperty('terramonitor', 'raster-opacity', 0.6)
            // map.setPaintProperty('peatland-co2', 'opacity', 0.6)


            // Ensure all symbol layers appear on top of satellite imagery.
            map.getStyle().layers.filter(x => x.type === 'symbol').forEach(layer => {
                // Rework Stadia default style to look nicer on top of satellite imagery
                window.layerOriginalPaint[layer.id] = {...layer.paint}
                window.invertLayerTextHalo(layer)
                map.removeLayer(layer.id)
                map.addLayer(layer)
                // map.moveLayer(layer.id)
            })

        });  // /map onload


        const privateDatasets = {}

        privateDatasets.valio = (map, secret) => {
            map.addSource('valio_fields', {
                "type": "vector",
                "tiles": [`https://map.buttonprogram.org/private/${secret}/valio_fields/{z}/{x}/{y}.pbf`],
                "maxzoom": 11,
            });

            map.addLayer({
                'id': 'valio-fields-fill',
                'source': 'valio_fields',
                'source-layer': 'valio_fields',
                'type': 'fill',
                'paint': {
                    'fill-color': [
                    'interpolate',
                    ['linear'],
                    ['to-number', ['get', 'histosol_ratio'], 0],
                    0, 'yellow',
                    1, 'red',
                    ],
                }
            })
            map.addLayer({
                'id': 'valio-fields-boundary',
                'source': 'valio_fields',
                'source-layer': 'valio_fields',
                'type': 'line',
                'paint': {
                    'line-opacity': 0.75,
                },
                "minzoom": 11,
            })
            map.addLayer({
                'id': 'valio-plohko-co2-sym',
                'source': 'valio_fields',
                'source-layer': 'valio_fields',
                // 'source-layer': 'suopellot',
                'type': 'symbol',
                "minzoom": 12,
                // 'maxzoom': zoomThreshold,
                "paint": {},
                "layout": {
                    "symbol-placement": "point",
                    "text-font": ["Open Sans Regular"],
                    // NB: 400t CO2eq/ha/20yrs -> 2kg/m2/y
                    // round(0.0002*total_area) -> reduce precision -> *10 -> 2kg/m2
                    "text-field":
                    ["case", ["has", "histosol_area"],
                        ["let", "suffix", "t CO2e/y",
                            ["concat",
                                ["to-string",
                                    ["*", 10,
                                        ["round", ["*", 0.0002, ["get", "total_area"]]],
                                    ]],
                                ["var", "suffix"],
                                "\npeat:", ["/",["round",['*', 0.001, ['to-number',["get", "histosol_area"],0]]],10],
                                "ha\ntotal:", ["/",["round",['*', 0.001, ["get", "total_area"]]],10],"ha",
                            ],
                        ],
                        "",
                    ],

                    "text-size": 20,
                }
            })
        };


        window.enablePrivateDatasets = function(secrets) {
            console.log('ENABLE SECRETS', secrets)
            window.map.on('load', () => {
                const originalMapLayerIds = {}
                map.getStyle().layers.forEach(x => originalMapLayerIds[x.id] = true)

                secrets.forEach(secret => {
                    const name = secret.split('-')[0];
                    const addLayerFn = privateDatasets[name];
                    console.log('ENABLE SECRETS', secrets, secret, name, addLayerFn)
                    addLayerFn(map, secret);
                    document.querySelector(`#layer-card-${name}`).removeAttribute('hidden');
                })

                // Hide new layers by default.
                map.getStyle().layers.map(layer => {
                    const isOldLayer = layer.id in originalMapLayerIds
                    isOldLayer || map.setLayoutProperty(layer.id, 'visibility', 'none')
                })
            })
        }


        window.useAllEteCodes = function(codes) {
            const id = 'metsaan-ete-all-sym'
            const isVisible = layerGroupState.ete
            const layer = map.getStyle().layers.filter(x => x.id ===id)[0]
            layer.layout['text-field'] = [
            "match",
            ["get","featurecode"],
            ...codes,
            "UNKNOWN habitat type",
            ];
            map.removeLayer(id)
            map.addLayer(layer)
            toggleGroup('ete'); toggleGroup('ete');
        }

        let reqCounter = 0
        let lastRequestSeen = 0
        window.setNO2 = function(currentRequestNum, e, lat, lon) {
            const elem = document.getElementById('no2')
            if (!layerGroupState['no2-raster'] || !currentRequestNum) {
                elem.innerHTML = ''
                return
            }

            // A quick and dirty mechanism to monotonically show only latest entries in spite of AJAX non-determinism.
            if (lastRequestSeen > currentRequestNum) return
            lastRequestSeen = Math.max(lastRequestSeen, currentRequestNum)

            const plusCode = '' // !OpenLocationCode ? '' : `, ${OpenLocationCode.encode(lat, lon, 6)}`
            const coords = ` at Latitude:${lat}, Longitude:${lon}${plusCode}`

            if (e.error || e.no2_concentration === null || e.no2_concentration === undefined) {
                elem.innerHTML = `NO2: ${e.error}${coords}`
            } else {
                const n = e.no2_concentration
                elem.innerHTML = `NO2: ${(n*1e6).toFixed(1)} µmol/m<sup>2</sup>${coords}`
            }
        }


        const updateNO2Reading = function (e) {
            if (!layerGroupState['no2-raster']) return
            const x = e.lngLat
            const lat = x.lat.toFixed(2)
            const lon = x.lng.toFixed(2)
            const url = `https://map.buttonprogram.org/query_no2?latitude=${lat}&longitude=${lon}&v=9`
            const currentRequestNum = ++reqCounter
            fetch(url)
            .then(function(response) {
                response.json().then(e => window.setNO2(currentRequestNum, e, lat, lon))
            })

            // console.log(e.point.x, e.point.y, e.lngLat.lat, e.lngLat.lng)
            // var features = map.queryRenderedFeatures(e.point);
            // console.log(features)
        }

        map.on('mousemove', updateNO2Reading);
        map.on('click', updateNO2Reading); // for mobile devices etc.

    </script>

</body>

</html>