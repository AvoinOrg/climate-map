<!DOCTYPE html>
<html lang='en'>

<head>
    <meta charset='utf-8' />
    <title>Button Climate Map</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/mapbox-gl/0.50.0/mapbox-gl.js" integrity="sha256-lt9+iIQZba05r6TN/Z7hzHD+QOWXdlzgARKHfA0U3ks=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mapbox-gl/0.50.0/mapbox-gl.css" integrity="sha256-coh6R3HyiYSLAbMk4lZIr5txQq3BdbN0nKl1U4iioNU=" crossorigin="anonymous" />

    <!-- plus.codes: -->
    <!-- <script async defer src="https://cdnjs.cloudflare.com/ajax/libs/openlocationcode/1.0.3/openlocationcode.min.js" integrity="sha256-cN2Y69HQRLjefvPHJKXQ9Dgkfug2odevw9BBdiyVExQ=" crossorigin="anonymous"></script> -->

    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        .hide {
            visibility: hidden;
        }

        .map-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            padding-bottom: 30px;
            background: rgba(255, 255, 255, 0.8);
            margin-right: 20px;
            overflow: auto;
            border-radius: 3px;
        }

        .toggle-legend {
            font-size: 1.4rem;
            padding: 0;
            margin-bottom: 2.5rem;
            background-color: rgba(42, 49, 67, 0.4);
            color: white;
            cursor: pointer;
        }

        #legend {
            max-height: 100vh;
            font-family: Arial, sans-serif;
        }

        #legend ul {
            list-style: none;
        }

        #no2 {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background-color: white;
            color: black;
            font-family: Arial, sans-serif;
        }

        .buttonbg h1 {
            font-size: 20px
        }

        .buttonbg {
            cursor: pointer;
            color: white;
            background: no-repeat left/90px url("button_logo.png");
            /* background-color: rgb(37, 39, 65); */
            background-color: rgb(42, 49, 67);
            font-family: sans-serif;
            padding-top: 10px;
            padding-left: 120px;
            min-height: 90px;
        }

        .logo {
            max-width: 10vw;
        }

        .peat {
            border: 15px solid #FFF;
            border-radius: 90px;
            height: 20px;
            width: 20px;
        }

        .peat1 {
            background-color: rgb(245, 17, 72);
        }

        .peat2 {
            background-color: rgb(252, 113, 34);
        }

        .peat3 {
            background-color: rgb(218, 248, 85);
        }

        .peat-natural {
            background-color: rgb(67, 213, 43);

        }

        .peat-recovering {
            box-shadow: 0 0 0 2px green;
        }
    </style>
</head>

<body>
    <div id='map'></div>

    <output id='no2'></output>

    <div class='map-overlay toggle-legend' onclick='toggleLegend()'>
        Show info
    </div>
    <div class='map-overlay' id='legend'>
        <header class='buttonbg' onclick='toggleLegend()'>
            <h1>Climate Map</h1>
            How are the emissions calculated?
        </header>
        <main>
            The demo calculations and scientific citations will be shown here.

            <ul>
                <li>Wet ditched peatland = remarkable emissions</li>
                <li>Dry ditched peatland = small emissions</li>
                <li>Very dry ditched peatland = usually not suitable for forestry</li>
            </ul>

            <table>
                <tr>
                    <td>
                        <div class='peat peat1'></div>
                    </td>
                    <td>
                        Wet ditched peatland with annual emissions over
                        <br /> 5,000 kg CO2/ha
                        <br /> 10 kg humus
                    </td>
                </tr>

                <tr>
                    <td>
                        <div class='peat peat2'></div>
                    </td>
                    <td>
                        Dry ditched peatland with annual emissions under
                        <br /> 5,000 kg CO2/ha
                        <br /> 10 kg humus
                    </td>
                </tr>

                <tr>
                    <td>
                        <div class='peat peat3'></div>
                    </td>
                    <td>
                        Very dry ditched peatland with annual emissions under
                        <br /> 1,000 kg CO2/ha
                        <br /> 2 kg humus
                    </td>
                </tr>

                <tr>
                    <td>
                        <div class='peat peat1 peat-recovering'></div>
                    </td>
                    <td>
                        Recovering peatland with annual emissions savings over
                        <br /> 1,000 kg CO2/ha
                        <br /> 2 kg humus
                    </td>
                </tr>

                <tr>
                    <td>
                        <div class='peat peat2 peat-recovering'></div>
                    </td>
                    <td>
                        Recovering peatland with annual emissions savings under
                        <br /> 1,000 kg CO2/ha
                        <br /> 2 kg humus
                    </td>
                </tr>
                <tr>
                    <td>
                        <div class='peat peat3 peat-recovering'></div>
                    </td>
                    <td>
                        Recovering peatland with annual emissions savings under
                        <br /> 500 kg CO2/ha
                        <br /> 0.5 kg humus
                    </td>
                </tr>

                <tr>
                    <td>
                        <div class='peat peat-natural'></div>
                    </td>
                    <td>
                        Natural state peatland with annually growing carbon sink
                        <br /> over 100 kg CO2/ha
                        <br />
                    </td>
                </tr>
            </table>
        </main>

        <ul>
            <li><button onclick="toggle('no2-raster')">Air pollution indicator NO2</button></li>
            <li><button onclick="toggle('terramonitor');toggleBaseMapSymbols()">Terramonitor satellite map</button></li>
            <li><button onclick="toggle('peatland-co2');toggle('peatland-co2-sym');toggle('peatland-outline');">Peatland forests CO2</button></li>
            <li><button onclick="toggle('plohko-fill');toggle('plohko-co2-sym');toggle('plohko-outline')">Peatland fields CO2</button></li>
            <li><button onclick="toggle('metsaan-hila-c');toggle('metsaan-hila-sym');toggle('metsaan-hila-outline')">Grid cell forest data</button></li>
            <li><button onclick="hideAll(x=>!/valio/.test(x));toggle('valio-fields-boundary');toggle('valio-fields-fill');toggle('valio-plohko-co2-sym')">Valio supply chain fields CO2</button></li>

            <li><button onclick="toggle('metsaan-stand-others-c')">All privately owned forests</button></li>

            <hr/>
            <li><button onclick="toggleEte()">All Especially Important Habitats (incl. METSO)</button></li>
            <li><button onclick="window.enableAllEteCodes()">Display ALL Habitat Descriptions</button></li>

            <!-- <li><button onclick="toggle('metsaan-ete-gamekeeping-area-c');">Gamekeeping areas</button></li> -->
            <!-- <li><button onclick="toggle('metsaan-ete-riistatiheikko');">Riistatiheikkö</button></li> -->
            <!-- <li><button onclick="toggle('metsaan-ete-possibly-metso-c');">Possibly a METSO program target</button></li>
            <li><button onclick="toggle('metsaan-ete-metso-c');">METSO habitat</button></li> -->
            <!-- <li><button onclick="toggle('metsaan-ete-metso2');">Metso II-program</button></li> -->

            <hr/>
            <!-- <li><button onclick="zonation(1);">Areas important to diversity - Zonation v1</button></li>
            <li><button onclick="zonation(2);">Areas important to diversity - Zonation v2</button></li>
            <li><button onclick="zonation(3);">Areas important to diversity - Zonation v3</button></li>
            <li><button onclick="zonation(4);">Areas important to diversity - Zonation v4</button></li>
            <li><button onclick="zonation(5);">Areas important to diversity - Zonation v5</button></li> -->
            <li><button onclick="zonation(6);">Areas important to diversity (Zonation)</button></li>

        </ul>
        <button style='font-weight:800; font-size:1.2em' onclick='toggleLegend()'>Hide info</button>
        <hr />
        <img alt="Metsäkeskus" src="metsakeskus_logo.jpg" class="logo">
        <img alt="Terramonitor" src="terramonitor_logo.jpg" class="logo">
        <br/>
        <img alt="Copernicus" src="copernicus_logo.jpg" class="logo">
        <img alt="ESA, European Space Agency" src="esa_logo.jpg" class="logo">
        <br/>
        <img alt="Mavi" src="mavi_logo.jpg" class="logo">
        <img alt="Luke" src="luke_logo.jpg" class="logo">
    </div>

    <script>
        window.changeMapStyle = function () {
            // map.setStyle(''); TODO
        }
        window.toggleLegend = function () {
            document.getElementById('legend').classList.toggle('hide')
        }
        const toggleableLayerIds = ['no2', 'peatland-co2-sym', 'peatland-co2', 'peatland-outline']
        const toggles = {
            'peatland-co2': true,
            'peatland-co2-sym': true,
            'plohko-fill': true,
            'plohko-co2-sym': true,
            'plohko-outline': true,
            'peatland-outline': true,
        }

        window.t = toggles
        window.toggle = function (id) {
            const state = toggles[id] = (toggles[id] === undefined ? false : !toggles[id])
            map.setLayoutProperty(id, 'visibility', state ? 'visible' : 'none')
            if (id === 'no2-raster') window.setNO2()
        }
        window.hideAll = function (filterFn) {
            for (const id in toggles) {
                if (filterFn && !filterFn(id)) continue;
                if (toggles[id]) {
                    map.setLayoutProperty(id, 'visibility', 'none')
                    toggles[id] = false
                }
            }
        }

        window.invertLayerTextHalo = function(layer) {
            layer.paint = {...layer.paint}
            if (layer.paint && layer.paint["text-halo-width"]) {
                // Original style is something like:
                // text-color: "#999"
                // text-halo-blur: 1
                // text-halo-color: "rgb(242,243,240)"
                // text-halo-width: 2
                layer.paint['text-halo-blur'] = 1
                layer.paint['text-halo-width'] = 2.5
                layer.paint['text-color'] = '#fff'
                layer.paint['text-halo-color'] = '#000'
            }
        }

        window.layerOriginalPaint = {}
        window.toggleBaseMapSymbols = function() {
            const id = 'terramonitor'
            const isSatelliteVisible = (toggles[id] === undefined ? false : !toggles[id])

            map.getStyle().layers.filter(x => x.type === 'symbol').forEach(layer => {
                if (isSatelliteVisible) {
                    layer.paint = window.layerOriginalPaint[layer.id];
                } else {
                    window.invertLayerTextHalo(layer);
                }
                map.removeLayer(layer.id);
                map.addLayer(layer);
                // map.moveLayer(layer.id)
            })
        }

        const zonation_versions = [1,2,3,4,5,6]
        window.zonation = function (v) {
            const id = `zonation-v${v}-raster`
            window.hideAll(x => /zonation/.test(x) && x !== id)
            const state = toggles[id] = (toggles[id] === undefined ? false : !toggles[id])
            map.setLayoutProperty(id, 'visibility', state ? 'visible' : 'none')
        }


        // This must be set, but the value is not needed here.
        mapboxgl.accessToken = 'not-needed';

        const style = {
            "version": 8,
            // "sprite": "https://map.buttonprogram.org/sprites",
            // "sources": {
            //     "stand-suot": {
            //         "type": "vector",
            //         "tiles": ["https://map.buttonprogram.org/stand-suot/{z}/{x}/{y}.pbf"],
            //         "maxzoom": 12,
            //     }
            // },
            "glyphs": "https://map.buttonprogram.org/suot/font/{fontstack}/{range}.pbf",
            "layers": [
                {
                    "id": "background",
                    "type": "background",
                    "paint": {
                        "background-color": "#ddeeff"
                    }
                },
            ]
        }

        const map = new mapboxgl.Map({
            container: 'map', // container id
            // style,
            style: 'https://tiles.stadiamaps.com/styles/alidade_smooth.json',
            center: [28, 65], // starting position [lng, lat]
            zoom: 5, // starting zoom
            attributionControl: false,
        });

        map.addControl(new mapboxgl.NavigationControl());

        map.on('load', function () {

            map.addLayer({
                'id': 'terramonitor',
                'type': 'raster',
                'source': {
                    'type': 'raster',
                    'tiles': [
                        'https://maps.terramonitor.com/9c2040ec0fb91cfdfd723496515d759a77b363ee/pro/wms?bbox={bbox-epsg-3857}&format=image/png&service=WMS&version=1.1.1&request=GetMap&srs=EPSG:3857&transparent=true&width=256&height=256&layers=rgb&styles=',
                    ],
                    'tileSize': 256,
                    // "maxzoom": 16, // After zoom level 16 the images (used to) get blurrier
                },
                'paint': {},
            });


            // Custom attribution for Terramonitor since the WMS source doesn't present show one automatically.
            map.addControl(new mapboxgl.AttributionControl({
                customAttribution: '<a href="https://www.terramonitor.com">© Terramonitor</a> | <a href="http://mavi.fi">© Maaseutuvirasto 2018</a>'
            }));

            map.addSource('stand-suot', {
                "type": "vector",
                "tiles": ["https://map.buttonprogram.org/stand-suot/{z}/{x}/{y}.pbf"],
                "maxzoom": 12,
            });

            map.addSource('metsaan-stand-others', {
                "type": "vector",
                "tiles": ["https://map.buttonprogram.org/stand-others/{z}/{x}/{y}.pbf"],
                "maxzoom": 13,
            });

            map.addSource('metsaan-hila', {
                "type": "vector",
                "tiles": ["https://map.buttonprogram.org/metsaan-hila/{z}/{x}/{y}.pbf"],
                "maxzoom": 15,
            });

            map.addSource('metsaan-ete', {
                "type": "vector",
                "tiles": ["https://map.buttonprogram.org/metsaan-ete/{z}/{x}/{y}.pbf"],
                "maxzoom": 12,
            });

            map.addSource('histosol_plohko', {
                "type": "vector",
                "tiles": ["https://map.buttonprogram.org/peltolohko/histosol_plohko/{z}/{x}/{y}.pbf"],
                "maxzoom": 11,
            });

            map.addLayer({
                'id': 'metsaan-stand-others-c',
                'source': 'metsaan-stand-others',
                'source-layer': 'stand-others',
                'type': 'fill',
                'paint': {
                    'fill-color': 'brown',
                    'fill-opacity': 0.5
                },
            })



            map.addLayer({
                'id': 'metsaan-hila-c',
                'source': 'metsaan-hila',
                'source-layer': 'metsaan-hila',
                'type': 'fill',
                'paint': {
                    'fill-color': [
                        'interpolate',
                        ['linear'],
                        ['get', 'age'],
                        0, 'rgb(218,248,85)', // green
                        70, 'rgb(252,113,34)', // orange
                        100, 'rgb(245,17,72)', // red
                    ],
                    'fill-opacity': 0.9
                },
            })
            map.addLayer({
                'id': 'metsaan-hila-outline',
                'source': 'metsaan-hila',
                'source-layer': 'metsaan-hila',
                'type': 'line',
                "minzoom": 14,
                'paint': {
                    'line-opacity': 0.75,
                }
            })
            map.addLayer({
                'id': 'metsaan-hila-sym',
                'source': 'metsaan-hila',
                'source-layer': 'metsaan-hila',
                'type': 'symbol',
                "minzoom": 15,
                // 'maxzoom': zoomThreshold,
                "paint": {},
                "layout": {
                    "symbol-placement": "point",
                    "text-font": ["Open Sans Regular"],
                    "text-field": 'Age:{age} Avg.Diameter:{meandiameter}',
                    "text-size": 10,
                }
            })


            map.addSource('metsaan-ete-gamekeeping-area', {
                "type": "geojson",
                "data": "https://map.buttonprogram.org/suot/ete_gamekeeping_area.geojson?v=1",
            });
            map.addSource('metsaan-ete-possibly-metso', {
                "type": "geojson",
                "data": "https://map.buttonprogram.org/suot/ete_possibly_metso.geojson?v=1",
            });
            map.addSource('metsaan-ete-metso', {
                "type": "geojson",
                "data": "https://map.buttonprogram.org/suot/ete_metso.geojson?v=1",
            });
            // map.addSource('metsaan-ete-riistatiheikko', {
            //     "type": "geojson",
            //     "data": "https://map.buttonprogram.org/suot/ete_riistatiheikko.geojson?v=1",
            // });
            // map.addSource('metsaan-ete-metso2', {
            //     "type": "geojson",
            //     "data": "https://map.buttonprogram.org/suot/ete_metso2.geojson?v=1",
            // });

            map.addLayer({
                'id': 'metsaan-ete-gamekeeping-area-c',
                'source': 'metsaan-ete-gamekeeping-area',
                'type': 'fill',
                'paint': {
                    'fill-color': '#40d040',
                    'fill-opacity': 0.7,
                },
            })
            map.addLayer({
                'id': 'metsaan-ete-possibly-metso-c',
                'source': 'metsaan-ete-possibly-metso',
                'type': 'fill',
                'paint': {
                    'fill-color': '#40d040',
                    'fill-opacity': 0.7,
                },
            })
            map.addLayer({
                'id': 'metsaan-ete-metso-c',
                'source': 'metsaan-ete-metso',
                'type': 'fill',
                'paint': {
                    'fill-color': '#40d040',
                    'fill-opacity': 0.7,
                },
            })

            // map.addLayer({
            //     'id': 'metsaan-ete-riistatiheikko',
            //     'source': 'metsaan-ete-riistatiheikko',
            //     'type': 'fill',
            //     'paint': {
            //         'fill-color': 'cyan',
            //         'fill-opacity': 0.7,
            //     },
            // })
            // map.addLayer({
            //     'id': 'metsaan-ete-metso2',
            //     'source': 'metsaan-ete-metso2',
            //     'type': 'fill',
            //     'paint': {
            //         'fill-color': 'cyan',
            //         'fill-opacity': 0.7,
            //     },
            // })


            map.addLayer({
                'id': 'metsaan-ete-all-c',
                'source': 'metsaan-ete',
                'source-layer': 'metsaan-ete',
                'type': 'fill',
                'paint': {
                    'fill-color': 'cyan',
                    'fill-opacity': 0.7,
                },
            })
            map.addLayer({
                'id': 'metsaan-ete-all-outline',
                'source': 'metsaan-ete',
                'source-layer': 'metsaan-ete',
                'type': 'line',
                "minzoom": 12,
                'paint': {
                    'line-opacity': 1,
                }
            })
            map.addLayer({
                'id': 'metsaan-ete-all-sym',
                'source': 'metsaan-ete',
                'source-layer': 'metsaan-ete',
                'type': 'symbol',
                "layout": {
                    "text-font": ["Open Sans Regular"],
                    "text-field": [
                        "match",
                        ["get","featurecode"],
                        70, "Gamekeeping area",
                        95, "METSO",
                        98, "Possibly METSO",
                        10120, "Gamekeeping area",
                        15150, "METSO II",
                        "",
                    ],
                    // "icon-image": "https://example.com/METSO_logo08_FI.gif",
                    //  [
                    //     // "step",
                    //     // [
                    //     //     "zoom"
                    //     // ],
                    //     // [
                    //         "match", ["get","featurecode"],
                    //         "95", "METSO_logo08_FI.gif",
                    //         null
                    // ],
                    // "text-field": ["get", "featurecode"],
                },
                paint: {
                    'text-color': "#999",
                    'text-halo-blur': 1,
                    'text-halo-color': "rgb(242,243,240)",
                    'text-halo-width': 2,
                },
            })


            map.addLayer({
                'id': 'plohko-fill',
                'source': 'histosol_plohko',
                'source-layer': 'suopellot',
                'type': 'fill',
                'paint': {
                    'fill-color': 'red',
                    'fill-opacity': 1
                }
            })
            map.addLayer({
                'id': 'plohko-outline',
                'source': 'histosol_plohko',
                'source-layer': 'suopellot',
                'type': 'line',
                "minzoom": 11,
                'paint': {
                    'line-opacity': 0.75,
                }
            })

            map.addLayer({
                'id': 'peatland-co2',
                'source': 'stand-suot',
                'source-layer': 'stand-suot',
                // 'maxzoom': zoomThreshold,
                'type': 'fill',
                // 'filter': ['==', 'isState', true],
                'paint': {
                    'fill-color': [
                        'interpolate',
                        ['linear'],
                        ['get', 'fertilityclass'],
                        1, 'rgb(245,17,72)', // red
                        4, 'rgb(252,113,34)', // orange
                        // 8, 'rgb(218,248,85)',
                        6, 'rgb(218,248,85)', // green
                    ],
                    // 'fill-outline-color': [
                    //     'interpolate',
                    //     ['linear'],
                    //     ['get', 'drainagestate'],
                    //     6, 'rgb(89, 122, 155)',
                    //     // 7, 'rgb(252,113,34)',
                    //     // 8, 'rgb(218,248,85)',
                    //     9, 'rgb(0, 77, 153)',
                    // ],
                    'fill-opacity': 0.9
                },
            })
            map.addLayer({
                'id': 'peatland-outline',
                'source': 'stand-suot',
                'source-layer': 'stand-suot',
                'type': 'line',
                "minzoom": 11,
                'paint': {
                    'line-opacity': 0.75,
                }
            })

            map.addLayer({
                'id': 'peatland-co2-sym',
                'source': 'stand-suot',
                'source-layer': 'stand-suot',
                'type': 'symbol',
                "minzoom": 12,
                // 'maxzoom': zoomThreshold,
                "paint": {},
                "layout": {
                    "symbol-placement": "point",
                    "text-font": ["Open Sans Regular"],
                    "text-field":
                    ["let", "suffix", "t CO2e/y",
                            ["concat",
                                ["to-string",
                                    ["/",
                                        ["round",
                                            ["*", 1.5,
                                                ["get", "co2"]]], 10]],
                                ["var", "suffix"]]],

                    "text-size": 20,
                }
            })

            map.addLayer({
                'id': 'plohko-co2-sym',
                'source': 'histosol_plohko',
                'source-layer': 'suopellot',
                'type': 'symbol',
                "minzoom": 12,
                // 'maxzoom': zoomThreshold,
                "paint": {},
                "layout": {
                    "symbol-placement": "point",
                    "text-font": ["Open Sans Regular"],
                    // NB: 400t CO2eq/ha/20yrs -> 2kg/m2/y
                    // round(0.0002*total_area) -> reduce precision -> *10 -> 2kg/m2
                    "text-field":
                        ["let", "suffix", "t CO2e/y",
                            ["concat",
                                ["to-string",
                                    ["*", 10,
                                        ["round", ["*", 0.0002, ["get", "total_area"]]],
                                    ]],
                                ["var", "suffix"]]],

                    "text-size": 20,
                }
            })


            map.addSource('valio_fields', {
                "type": "geojson",
                "data": "https://map.buttonprogram.org/suot/valio_fields.geojson?v=2",
            });


            map.addLayer({
                'id': 'valio-fields-fill',
                'source': 'valio_fields',
                'type': 'fill',
                'paint': {
                    'fill-color': [
                        'interpolate',
                        ['linear'],
                        ['to-number', ['get', 'histosol_ratio'], 0],
                        0, 'yellow',
                        1, 'red',
                    ],
                }
            })
            map.addLayer({
                'id': 'valio-fields-boundary',
                'source': 'valio_fields',
                'type': 'line',
                'paint': {
                    'line-opacity': 0.75,
                },
                "minzoom": 11,
            })
            map.addLayer({
                'id': 'valio-plohko-co2-sym',
                'source': 'valio_fields',
                // 'source-layer': 'suopellot',
                'type': 'symbol',
                "minzoom": 12,
                // 'maxzoom': zoomThreshold,
                "paint": {},
                "layout": {
                    "symbol-placement": "point",
                    "text-font": ["Open Sans Regular"],
                    // NB: 400t CO2eq/ha/20yrs -> 2kg/m2/y
                    // round(0.0002*total_area) -> reduce precision -> *10 -> 2kg/m2
                    "text-field":
                        ["let", "suffix", "t CO2e/y",
                            ["concat",
                                ["to-string",
                                    ["*", 10,
                                        ["round", ["*", 0.0002, ["get", "total_area"]]],
                                    ]],
                                ["var", "suffix"],
                                "\npeat:",["/",["round",['*', 0.001, ['to-number',["get", "histosol_area"],0]]],10],
                                "ha\ntotal:",["/",["round",['*', 0.001, ["get", "total_area"]]],10],"ha",
                            ]
                        ],

                    "text-size": 20,
                }
            })


            let no2Tileset = Number.parseInt( window.location.search.substring(1) ) || 0
            const timestampHour = Math.round(+new Date() / 1e6)
            map.addSource('no2-tiles', {
                "type": "raster",
                "tiles": ["https://map.buttonprogram.org/atmoshack/mbtiles-dump/" + no2Tileset + "/{z}/{x}/{y}.png?v=5&_=" + timestampHour],
                "maxzoom": 5,
            });
            
            map.addLayer({
                'id': 'no2-raster',
                'source': 'no2-tiles',
                'type': 'raster',
                'minzoom': 0,
                'maxzoom': 10,
            })


            map.addLayer({
                'id': 'mangrove-wms',
                'type': 'raster',
                'source': {
                    'type': 'raster',
                    'tiles': [
                        'https://gis.unep-wcmc.org/arcgis/services/marine/GMW_001_MangroveDistribition_2010/MapServer/WMSServer?bbox={bbox-epsg-3857}&format=image/png&service=WMS&version=1.1.1&request=GetMap&srs=EPSG:3857&transparent=true&width=256&height=256&layers=0&styles=default',
                    ],
                    'tileSize': 256
                },
                'paint': {}
            })

            zonation_versions.map(v => {
                const sourceName = `zonation-v${v}`
                const id = `${sourceName}-raster`
                map.addSource(sourceName, {
                    "type": "raster",
                    "tiles": [`https://map.buttonprogram.org/suot/zonation/MetZa2018_VMA0${v}/{z}/{x}/{y}.png?v=5`],
                    "minzoom": 5,
                    "maxzoom": 9,
                });
                map.addLayer({
                    id,
                    'source': sourceName,
                    'type': 'raster',
                    'minzoom': 0,
                    // 'maxzoom': 10,
                })
                toggle(id)
                map.setPaintProperty(id, 'raster-opacity', 0.6)
            })

            // The NO2 layer is off by default, but it can be enabled
            // on page load with a URL parameter string like "?0".
            if (!window.location.search.substring(1)) {
                toggle('no2-raster')
            }

            toggle('metsaan-stand-others-c')

            toggle('metsaan-hila-c')
            toggle('metsaan-hila-outline')
            toggle('metsaan-hila-sym')

            toggle('metsaan-ete-all-c')
            toggle('metsaan-ete-all-outline')
            toggle('metsaan-ete-all-sym')

            toggle('valio-fields-boundary')
            toggle('valio-fields-fill')
            toggle('valio-plohko-co2-sym')

            toggle('metsaan-ete-gamekeeping-area-c')
            // toggle('metsaan-ete-riistatiheikko');
            toggle('metsaan-ete-possibly-metso-c');
            toggle('metsaan-ete-metso-c');
            // toggle('metsaan-ete-metso2');


            map.setPaintProperty('no2-raster', 'raster-opacity', 0.7)
            // map.setPaintProperty('terramonitor', 'raster-opacity', 0.6)
            // map.setPaintProperty('peatland-co2', 'opacity', 0.6)


            // Ensure all symbol layers appear on top of satellite imagery.
            map.getStyle().layers.filter(x => x.type === 'symbol').forEach(layer => {
                // Rework Stadia default style to look nicer on top of satellite imagery
                window.layerOriginalPaint[layer.id] = {...layer.paint}
                window.invertLayerTextHalo(layer)
                map.removeLayer(layer.id)
                map.addLayer(layer)
                // map.moveLayer(layer.id)
            })

        });  // /map onload


        window.useAllEteCodes = function(codes) {
            const id = 'metsaan-ete-all-sym'
            const isVisible = (toggles[id] === undefined ? false : !toggles[id])
            const layer = map.getStyle().layers.filter(x => x.id ===id)[0]
            layer.layout['text-field'] = [
                "match",
                ["get","featurecode"],
                ...codes,
                "",
            ];
            map.removeLayer(id)
            map.addLayer(layer)
            toggle(id); toggle(id);
        }

        // NB: Use with caution. Very heavy.
        window.toggleEte = function() {
            toggle('metsaan-ete-all-c');
            toggle('metsaan-ete-all-outline');
            toggle('metsaan-ete-all-sym');
        }
        window.enableAllEteCodes = function() {
            fetch('ete_codes.json').then(function(response) {
                response.json().then(e => {
                    window.useAllEteCodes(e);
                    window.toggleEte();
                })
            })
        }


        let reqCounter = 0
        let lastRequestSeen = 0
        window.setNO2 = function(currentRequestNum, e, lat, lon) {
            const elem = document.getElementById('no2')
            if (toggles['no2-raster']===false || !currentRequestNum) {
                elem.innerHTML = ''
                return
            }

            // A quick and dirty mechanism to monotonically show only latest entries in spite of AJAX non-determinism.
            if (lastRequestSeen > currentRequestNum) return
            lastRequestSeen = Math.max(lastRequestSeen, currentRequestNum)

            const plusCode = '' // !OpenLocationCode ? '' : `, ${OpenLocationCode.encode(lat, lon, 6)}`
            const coords = ` at Latitude:${lat}, Longitude:${lon}${plusCode}`

            if (e.error || e.no2_concentration === null || e.no2_concentration === undefined) {
                elem.innerHTML = `NO2: ${e.error}${coords}`
            } else {
                const n = e.no2_concentration
                elem.innerHTML = `NO2: ${(n*1e6).toFixed(1)} µmol/m<sup>2</sup>${coords}`
            }
        }



        const updateNO2Reading = function (e) {
            if (toggles['no2-raster']===false) return
            const x = e.lngLat
            const lat = x.lat.toFixed(2)
            const lon = x.lng.toFixed(2)
            const url = `https://map.buttonprogram.org/query_no2?latitude=${lat}&longitude=${lon}&v=9`
            const currentRequestNum = ++reqCounter
            fetch(url)
              .then(function(response) {
                response.json().then(e => window.setNO2(currentRequestNum, e, lat, lon))
              })

            // console.log(e.point.x, e.point.y, e.lngLat.lat, e.lngLat.lng)
            // var features = map.queryRenderedFeatures(e.point);
            // console.log(features)
        }

        map.on('mousemove', updateNO2Reading);
        map.on('click', updateNO2Reading); // for mobile devices etc.

    </script>

</body>

</html>